@using EA.Weee.Web.Areas.Admin.Controllers
@using MvcNavigationHelpers
@model EA.Weee.Web.Areas.Admin.ViewModels.Submissions.SubmissionsHistoryViewModel
@{
    ViewBag.Title = "Submissions history";
}

<section>
    <header class="hgroup">
        <h1 class="govuk-heading-l">Submissions history</h1>
    </header>

    <div class="govuk-grid-column-full">
        <p>View submissions for:</p>
        <div class="govuk-form-group @Html.Gds().FormGroupClass(m => m.SelectedYear)">
            @Html.Gds().LabelFor(m => m.SelectedYear)
            @Html.Gds().ValidationMessageFor(m => m.SelectedYear)
            @Html.Gds().DropDownListFor(m => m.SelectedYear, Model.ComplianceYears, new { @class = "govuk-!-width-one-half", autocomplete = "false" })
        </div>
        <div class="govuk-form-group @Html.Gds().FormGroupClass(m => m.SelectedScheme)">
            @Html.Gds().LabelFor(m => m.SelectedScheme)
            @Html.Gds().ValidationMessageFor(m => m.SelectedScheme)
            @Html.Gds().DropDownListFor(m => m.SelectedScheme, Model.SchemeNames, new { @class = "govuk-!-width-one-half", autocomplete = "false" })
        </div>

        <p>
            <span class="font-bold">Submission type:</span> Member registrations
        </p>
    </div>

    <div class="govuk-form-group" id="submissionResults"></div>

    <div class="govuk-form-group" id="noPCSResults">
        <p>
            <u>Why are there no PCS in the dropdown list?</u> <br />
            In order to be shown in the list, a PCS must be currently in the Approved status or, if it is in Withdrew status it must have submissions present for the selected compliance year.
        </p>
    </div>

    <p class="left-cleared">
        <a href="javascript:history.back();">Back</a>
    </p>
</section>

@section scripts {
    <script type="text/javascript">
        $(document).ready(function () {
            var selectedYear = $("#SelectedYear").val();
            var selectedScheme = $("#SelectedScheme").val();
            FetchSubmissionResults(selectedYear, selectedScheme);
            $('#noPCSResults').hide();
        });

        function FetchSubmissionResults(selectedYear, selectedScheme) {
            $.ajax({
                url: '@Url.Action("FetchSubmissionResults")',
                type: 'POST',
                cache: false,
                data: { year: selectedYear, schemeId: selectedScheme, __RequestVerificationToken: $("[name=__RequestVerificationToken]").val() },
                success: function (data) {
                    $('#submissionResults').html(data);
                }
            });
        }

        function FectSchemeForComplainceYear(selectedYear) {
            $.ajax({
                type: "POST",
                url: '@Url.Action("FetchSchemeForComplainceYear")',
                cache: false,
                data: { complianceYear: selectedYear, __RequestVerificationToken: $("[name=__RequestVerificationToken]").val() },
                success: function (data) {
                    // Clear options
                    $("#SelectedScheme").find("option").remove();

                    // Loop through JSON response
                    $.each(data, function (index, item) {
                        $('#SelectedScheme').append('<option value="' + item.Value + '">' + item.Text + '</option>');
                    })

                    if (data.length == 0) {
                        $('#noPCSResults').show();
                    } else {
                        $('#noPCSResults').hide();
                    }

                    var selectedScheme = $("#SelectedScheme").val();
                    FetchSubmissionResults(selectedYear, selectedScheme);
                }
            });
        }

        $("#SelectedYear").change(function () {

                var selectedYear = $(this).val();
                FectSchemeForComplainceYear(selectedYear);
            });

        $("#SelectedScheme").change(function () {
                var selectedScheme = $(this).val();
                var selectedYear = $("#SelectedYear").val();
                FetchSubmissionResults(selectedYear, selectedScheme);
            });
    </script>
}

